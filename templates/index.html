
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity OMR | Production Dashboard</title>
    <!-- Modern Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Ambient Background Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 0% 0%, rgba(0, 242, 254, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(79, 172, 254, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* Sidebar */
        aside {
            width: 280px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex; box-align: center; gap: 0.5rem;
        }

        nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item {
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex; align-items: center; gap: 1rem;
            transition: 0.3s;
            color: var(--text-dim);
            font-weight: 500;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--glass);
            color: var(--text);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
        }
        .nav-item.active { border-left: 4px solid var(--primary); }

        /* Main Content */
        main {
            flex: 1;
            padding: 3rem;
            overflow-y: auto;
            position: relative;
        }

        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 3rem; }

        /* Modern Components */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .upload-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 20px;
            padding: 4rem;
            text-align: center;
            transition: 0.3s;
            cursor: pointer;
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(0, 242, 254, 0.05); }

        .btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0, 242, 254, 0.2); }

        /* Results Table */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 1rem; color: var(--text-dim); border-bottom: 1px solid var(--glass-border); }
        td { padding: 1rem; border-bottom: 1px solid var(--glass-border); }
        .status-pill { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; }
        .status-pill.correct { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-pill.wrong { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        /* Analysis Viewer */
        .analysis-grid { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; }
        .image-container { background: #000; border-radius: 12px; overflow: hidden; height: 600px; }
        .image-container img { width: 100%; height: 100%; object-fit: contain; }

        .loader {
            width: 48px; height: 48px;
            border: 5px solid var(--glass);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Stats Cards */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--glass); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--glass-border); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: var(--text-dim); }

    </style>
</head>
<body>
    <div class="ambient-bg"></div>

    <aside>
        <div class="logo">
            <i data-lucide="layers"></i> INFINITY OMR
        </div>
        <nav>
            <div class="nav-item active" onclick="showSection('upload')">
                <i data-lucide="upload-cloud"></i> 1. Upload Sheets
            </div>
            <div class="nav-item" onclick="showSection('answer')">
                <i data-lucide="key"></i> 2. Answer Key
            </div>
            <div class="nav-item" onclick="showSection('eval')">
                <i data-lucide="cpu"></i> 3. Evaluation
            </div>
            <div class="nav-item" onclick="showSection('analysis')">
                <i data-lucide="pie-chart"></i> 4. Deep Analysis
            </div>
            <div class="nav-item" onclick="showSection('export')">
                <i data-lucide="download"></i> 5. Export Reports
            </div>
        </nav>
        <div style="margin-top:auto">
            <div class="nav-item" style="color:var(--error)" onclick="clearAll()">
                <i data-lucide="trash-2"></i> Reset Session
            </div>
        </div>
    </aside>

    <main>
        <!-- 1. UPLOAD -->
        <section id="upload" class="section active">
            <h1>Upload Test Sheets</h1>
            <p class="subtitle">Upload students images for processing. Supports JPEG, PNG.</p>
            <div class="glass-card">
                <input type="file" id="testFiles" multiple hidden onchange="handleFiles('test')">
                <div class="upload-zone" onclick="document.getElementById('testFiles').click()">
                    <i data-lucide="file-up" style="width:48px; height:48px; color:var(--primary)"></i>
                    <p style="margin-top:1rem">Drag and drop images or click to browse</p>
                    <p id="testCount" style="color:var(--text-dim); margin-top:0.5rem">0 files selected</p>
                </div>
            </div>
            <div id="testPreview" class="glass-card" style="display:none">
                <h3>Selected Files</h3>
                <div id="testList" style="margin-top:1rem; opacity:0.7"></div>
            </div>
        </section>

        <!-- 2. ANSWER KEY -->
        <section id="answer" class="section">
            <h1>Official Answer Key</h1>
            <p class="subtitle">Upload the official key sheet for calibration and grading.</p>
            <div class="glass-card">
                <input type="file" id="keyFile" hidden onchange="handleFiles('answer')">
                <div class="upload-zone" onclick="document.getElementById('keyFile').click()">
                    <i data-lucide="check-circle" style="width:48px; height:48px; color:var(--secondary)"></i>
                    <p style="margin-top:1rem">Upload single Answer Key image</p>
                    <p id="keyName" style="color:var(--text-dim); margin-top:0.5rem">No file selected</p>
                </div>
            </div>
        </section>

        <!-- 3. EVALUATION -->
        <section id="eval" class="section">
            <h1>Neural Evaluation</h1>
            <p class="subtitle">Run the CNN-powered OMR engine to grade all sheets.</p>
            <div class="glass-card" style="text-align:center; padding: 5rem 0">
                <div id="evalIdle">
                    <button class="btn" onclick="startEvaluation()">
                        <i data-lucide="play"></i> Start Processing
                    </button>
                    <p style="margin-top:1rem; color:var(--text-dim)">Using omr_model.keras v1.0.0</p>
                </div>
                <div id="evalRunning" style="display:none">
                    <div class="loader"></div>
                    <p style="margin-top:1rem">Analyzing sheets via Vision Pipeline...</p>
                </div>
                <div id="evalComplete" style="display:none">
                    <i data-lucide="check-circle-2" style="width:64px; height:64px; color:var(--success)"></i>
                    <h2 style="margin-top:1rem">Processing Complete</h2>
                    <p style="color:var(--text-dim)">All sheets have been analyzed successfully.</p>
                    <button class="btn" onclick="showSection('analysis')" style="margin-top:2rem">View Results</button>
                </div>
            </div>
        </section>

        <!-- 4. ANALYSIS -->
        <section id="analysis" class="section">
            <h1>Detailed Analysis</h1>
            <p class="subtitle">Interact with student sheets and verify neural predictions.</p>
            
            <div class="analysis-grid">
                <div class="image-viewer">
                    <div class="glass-card" style="padding:1rem">
                        <div class="image-container">
                            <img id="analysisImage" src="" alt="Select a sheet">
                        </div>
                    </div>
                </div>
                <div class="results-pane">
                    <div class="glass-card">
                        <select id="sheetSelector" onchange="updateAnalysisView()" style="width:100%; padding:0.8rem; background:var(--bg); border:1px solid var(--glass-border); color:var(--text); border-radius:8px">
                            <option value="">Select Student Sheet</option>
                        </select>
                        
                        <div id="sheetStats" style="margin-top:2rem">
                            <div class="stat-card" style="margin-bottom:1rem">
                                <div class="stat-val" id="dispScore">-</div>
                                <div class="stat-label">Total Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-val" id="dispAcc" style="color:var(--secondary)">-</div>
                                <div class="stat-label">Accuracy</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card" style="max-height:300px; overflow-y:auto">
                        <h3>Detailed Breakdown</h3>
                        <div id="breakdownList" style="margin-top:1rem; font-size:0.9rem"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. EXPORT -->
        <section id="export" class="section">
            <h1>Reports & Exports</h1>
            <p class="subtitle">Download final grades and evaluation metrics.</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem">
                <div class="glass-card" style="text-align:center">
                    <i data-lucide="table" style="width:48px; height:48px; margin-bottom:1rem; color:var(--primary)"></i>
                    <h3>General Report (CSV)</h3>
                    <p style="color:var(--text-dim); margin-bottom:2rem">Spreadsheet with scores and stats</p>
                    <button class="btn" onclick="downloadCSV()">Download CSV</button>
                </div>
                <div class="glass-card" style="text-align:center">
                    <i data-lucide="file-json" style="width:48px; height:48px; margin-bottom:1rem; color:var(--secondary)"></i>
                    <h3>Raw Data (JSON)</h3>
                    <p style="color:var(--text-dim); margin-bottom:2rem">Detailed JSON for system integration</p>
                    <button class="btn" onclick="downloadJSON()">Download JSON</button>
                </div>
            </div>

            <div class="glass-card" style="margin-top:2rem">
                <h3>Printing Service</h3>
                <p style="color:var(--text-dim); margin-bottom:2rem">Generate a printable summary table of all students.</p>
                <button class="btn" style="background:var(--glass); color:var(--text); border:1px solid var(--glass-border)" onclick="window.print()">
                    <i data-lucide="printer"></i> Print Summary
                </button>
            </div>
        </section>
    </main>

    <script>
        lucide.createIcons();
        let globalResults = [];

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function handleFiles(type) {
            const input = type === 'test' ? document.getElementById('testFiles') : document.getElementById('keyFile');
            const files = Array.from(input.files);
            
            if (type === 'test') {
                document.getElementById('testCount').textContent = `${files.length} files selected`;
                document.getElementById('testPreview').style.display = 'block';
                document.getElementById('testList').innerHTML = files.map(f => `<div>â€¢ ${f.name}</div>`).join('');
            } else {
                document.getElementById('keyName').textContent = files[0].name;
            }

            // Upload to server
            const formData = new FormData();
            formData.append('type', type);
            files.forEach(f => formData.append('files', f));

            const res = await fetch('/upload', { method: 'POST', body: formData });
            const data = await res.json();
            console.log(data);
        }

        async function startEvaluation() {
            document.getElementById('evalIdle').style.display = 'none';
            document.getElementById('evalRunning').style.display = 'block';

            try {
                const res = await fetch('/process', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    globalResults = data.results;
                    updateSelectors();
                    document.getElementById('evalRunning').style.display = 'none';
                    document.getElementById('evalComplete').style.display = 'block';
                } else {
                    alert(data.message);
                    document.getElementById('evalIdle').style.display = 'block';
                    document.getElementById('evalRunning').style.display = 'none';
                }
            } catch (e) {
                alert("Evaluation Failed: " + e.message);
            }
        }

        function updateSelectors() {
            const sel = document.getElementById('sheetSelector');
            sel.innerHTML = '<option value="">Select Student Sheet</option>' + 
                globalResults.map((r, i) => `<option value="${i}">${r.filename}</option>`).join('');
        }

        function updateAnalysisView() {
            const idx = document.getElementById('sheetSelector').value;
            if (idx === "") return;

            const res = globalResults[idx];
            document.getElementById('analysisImage').src = `/static/web_outputs/debug_${res.filename}?t=${Date.now()}`;
            document.getElementById('dispScore').textContent = res.score;
            document.getElementById('dispAcc').textContent = res.accuracy;

            const breakdown = document.getElementById('breakdownList');
            breakdown.innerHTML = Object.entries(res.details)
                .map(([q, status]) => `
                    <div style="display:flex; justify-content:space-between; padding:0.3rem 0; border-bottom:1px solid var(--glass-border)">
                        <span>Q${q}</span>
                        <span class="status-pill ${status.toLowerCase()}">${status}</span>
                    </div>
                `).join('');
        }

        async function clearAll() {
            if (!confirm("Clear all uploads and results?")) return;
            await fetch('/clear', { method: 'POST' });
            location.reload();
        }

        function downloadCSV() {
            if (globalResults.length === 0) return alert("No results to export");
            const head = "File,Score,Accuracy,Correct,Wrong,Invalid,Blank\n";
            const body = globalResults.map(r => `${r.filename},${r.score},${r.accuracy},${r.stats[0]},${r.stats[1]},${r.stats[2]},${r.stats[3]}`).join("\n");
            downloadFile(head + body, "omr_report.csv", "text/csv");
        }

        function downloadJSON() {
            if (globalResults.length === 0) return alert("No results to export");
            downloadFile(JSON.stringify(globalResults, null, 2), "omr_data.json", "application/json");
        }

        function downloadFile(content, name, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = name; a.click();
        }
    </script>
</body>
</html>
